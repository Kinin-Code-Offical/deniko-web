// ========================================================
// âš™ï¸ KONFÄ°GÃœRASYON
// ========================================================

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
}

// ========================================================
// ğŸ‘¤ 1. KÄ°MLÄ°K VE DOÄRULAMA (AUTH & USER)
// KullanÄ±cÄ±larÄ±n sisteme giriÅŸi, hesap gÃ¼venliÄŸi ve temel bilgileri.
// ========================================================

/// Sisteme giriÅŸ yapan gerÃ§ek kiÅŸi (Ã–ÄŸretmen veya Ã–ÄŸrenci olabilir).
model User {
  id String @id @default(uuid())

  // -- Kimlik Bilgileri --
  name          String? // Google/Provider'dan gelen tam isim
  firstName     String? // Manuel girilen ad
  lastName      String? // Manuel girilen soyad
  username      String?  @unique // KullanÄ±cÄ± adÄ± Public Name
  email         String?   @unique
  emailVerified DateTime?
  image         String?   // GCS Key or External URL
  avatarVersion Int       @default(0)
  password      String?
  phoneNumber   String?

  // -- Soft Delete --
  isDeleted   Boolean   @default(false)
  deletedAt   DateTime?

  // -- Roller ve Durumlar --
  role                  Role?
  isActive              Boolean @default(true)
  isOnboardingCompleted Boolean @default(false)
  
  // -- Settings Preferences --
  settings UserSettings?

  notificationEmailEnabled  Boolean @default(true)
  notificationInAppEnabled  Boolean @default(true)
  preferredCountry          String?
  preferredTimezone         String?
  cookieAnalyticsEnabled    Boolean @default(false)
  isMarketingConsent    Boolean @default(false)


  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // -- Profil BaÄŸlantÄ±larÄ± (Polimorfik yapÄ± benzeri) --
  teacherProfile TeacherProfile?
  studentProfile StudentProfile?

  // -- Auth.js (NextAuth) Ä°liÅŸkileri --
  accounts Account[]
  sessions Session[]
  emailChangeRequests EmailChangeRequest[]

  // -- DiÄŸer Ä°liÅŸkiler --
  devices          Device[]
  notifications    Notification[]
  sentMessages     Message[]      @relation("SentMessages")
  receivedMessages Message[]      @relation("ReceivedMessages")
  todos            Todo[]
  calendarEvents   Event[]
  files            File[]
}

/// KullanÄ±cÄ± gizlilik ve tercih ayarlarÄ±.
model UserSettings {
  id               String   @id @default(uuid())
  userId           String   @unique
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  profileVisibility String  @default("public") // "public" | "private"
  showAvatar        Boolean @default(true)
  showEmail         Boolean @default(false)
  showPhone         Boolean @default(false)
  allowMessages     Boolean @default(true)
  showCourses       Boolean @default(true)

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

/// OAuth hesaplarÄ± (Google, Apple vb. ile giriÅŸ iÃ§in).
model Account {
  id                String  @id @default(uuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

/// Oturum yÃ¶netimi.
model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

/// E-posta doÄŸrulama tokenlarÄ±.
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

/// Åifre sÄ±fÄ±rlama tokenlarÄ±.
model PasswordResetToken {
  id      String   @id @default(uuid())
  email   String
  token   String   @unique
  expires DateTime

  @@unique([email, token])
}

/// E-posta deÄŸiÅŸikliÄŸi istekleri.
model EmailChangeRequest {
  id        String   @id @default(uuid())
  userId    String
  newEmail  String
  token     String   @unique
  expires   DateTime
  usedAt    DateTime?

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

/// KullanÄ±cÄ±nÄ±n giriÅŸ yaptÄ±ÄŸÄ± cihazlar (Bildirim gÃ¶ndermek iÃ§in).
model Device {
  id         String     @id @default(uuid())
  userId     String
  deviceType DeviceType
  deviceId   String?
  model      String?
  fcmToken   String? // Firebase Cloud Messaging Token
  lastActive DateTime   @default(now())
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, deviceId])
}

// ========================================================
// ğŸ“ 2. PROFÄ°LLER (AKADEMÄ°K KÄ°MLÄ°KLER)
// KullanÄ±cÄ±nÄ±n sistemdeki rolÃ¼ne (Ã–ÄŸretmen/Ã–ÄŸrenci) gÃ¶re tutulan veriler.
// ========================================================

/// Ã–ÄŸretmen profili. Dersler, sÄ±nÄ±flar ve finansal veriler buraya baÄŸlÄ±dÄ±r.
model TeacherProfile {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  branch String // BranÅŸ (Ã–rn: Matematik)
  bio    String? // Profil yazÄ±sÄ±

  // -- Ä°liÅŸkiler --
  studentRelations StudentTeacherRelation[] // Ã–ÄŸrenci listesi
  classes          Classroom[] // SÄ±nÄ±flarÄ±
  lessons          Lesson[] // VerdiÄŸi dersler
  payments         Payment[] // AldÄ±ÄŸÄ± Ã¶demeler
  scheduleItems    ScheduleItem[] // Ders programÄ± ÅŸablonlarÄ±
}

/// Ã–ÄŸrenci profili. Hem gerÃ§ek kullanÄ±cÄ±lar hem de "GÃ¶lge Hesaplar" (User'Ä± olmayan) iÃ§in kullanÄ±lÄ±r.
model StudentProfile {
  id String @id @default(uuid())

  // -- A. Kimlik BaÄŸlantÄ±sÄ± --
  // userId VARSA -> UygulamayÄ± kullanan gerÃ§ek Ã¶ÄŸrenci.
  // userId YOKSA -> Ã–ÄŸretmenin manuel eklediÄŸi "GÃ¶lge Hesap".
  userId String? @unique
  user   User?   @relation(fields: [userId], references: [id])

  // -- B. GÃ¶lge Hesap Bilgileri --
  tempFirstName String?
  tempLastName  String?
  tempPhone     String?
  tempEmail     String?
  tempAvatarKey String?

  // -- C. Davet ve Durum --
  inviteToken        String?   @unique
  inviteTokenExpires DateTime? // Token'Ä±n geÃ§erlilik sÃ¼resi
  isClaimed          Boolean   @default(false)
  creatorTeacherId   String? // Bu Ã¶ÄŸrenciyi sisteme ilk kim ekledi?

  // -- D. Akademik Bilgiler --
  studentNo   String?
  gradeLevel  String? // Ã–rn: "12. SÄ±nÄ±f"
  parentName  String?
  parentPhone String?
  parentEmail String?

  // -- E. Ä°liÅŸkiler --
  teacherRelations   StudentTeacherRelation[] // BaÄŸlÄ± olduÄŸu Ã¶ÄŸretmenler
  classrooms         Classroom[] // Dahil olduÄŸu sÄ±nÄ±flar
  recurringSchedules ScheduleItem[] // Kendisine Ã¶zel ders programÄ±
  lessons            Lesson[]                 @relation("LessonToStudentProfile")
  homeworkTrackings  HomeworkTracking[]
  submissions        HomeworkSubmission[]
  payments           Payment[]
  grades             SchoolExam[]
  trialExams         TrialExam[]
  attendances        Attendance[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/// Ã–ÄŸretmen ve Ã–ÄŸrenci arasÄ±ndaki baÄŸlantÄ± tablosu (Many-to-Many).
/// Ã–ÄŸretmen, Ã¶ÄŸrenciyi kendi listesinde nasÄ±l gÃ¶rÃ¼yor?
model StudentTeacherRelation {
  id String @id @default(uuid())

  teacherId String
  teacher   TeacherProfile @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  studentId String
  student   StudentProfile @relation(fields: [studentId], references: [id], onDelete: Cascade)

  status    RelationStatus @default(ACTIVE)
  isCreator Boolean        @default(false) // Ã–ÄŸrenciyi bu Ã¶ÄŸretmen mi oluÅŸturdu?

  // Ã–ÄŸretmene Ã¶zel isimlendirme (Ã–rn: "Ahmet (12-B)")
  customName   String?
  privateNotes String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([teacherId, studentId])
}

// ========================================================
// ğŸ« 3. AKADEMÄ°K YAPI (SINIF & DERS PROGRAMI)
// ========================================================

/// SÄ±nÄ±f veya Grup (Ã–rn: "12-A", "LGS Grubu").
model Classroom {
  id   String @id @default(uuid())
  name String
  year Int // Ã–rn: 2025

  teacherId String?
  teacher   TeacherProfile? @relation(fields: [teacherId], references: [id])

  students StudentProfile[] // SÄ±nÄ±ftaki Ã¶ÄŸrenciler
  schedule ScheduleItem[] // SÄ±nÄ±fÄ±n ders programÄ±
  lessons  Lesson[] // SÄ±nÄ±fÄ±n iÅŸlenen dersleri
}

/// ğŸ“… DERS PROGRAMI ÅABLONU (Recurring Schedule)
/// "Her Pazartesi 09:00'da Matematik var" kuralÄ±nÄ± tutar.
model ScheduleItem {
  id String @id @default(uuid())

  // -- Zamanlama KuralÄ± --
  dayOfWeek Int // 1=Pazartesi ... 7=Pazar
  startTime String // "09:00"
  endTime   String // "09:40"

  // -- VarsayÄ±lan Ders Bilgileri --
  subject     String?
  type        LessonType     @default(PRIVATE)
  location    LessonLocation @default(ONLINE)
  locationUrl String?
  address     String?
  price       Decimal?       @db.Decimal(10, 2)
  currency    String         @default("TRY")

  // -- Ä°liÅŸkiler --
  teacherId String
  teacher   TeacherProfile @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  // Kime ait? (SÄ±nÄ±f veya Ã–zel Ã–ÄŸrenci)
  classroomId String?
  classroom   Classroom?      @relation(fields: [classroomId], references: [id], onDelete: Cascade)
  studentId   String?
  student     StudentProfile? @relation(fields: [studentId], references: [id], onDelete: Cascade)

  // Bu ÅŸablondan Ã¼retilen gerÃ§ek dersler
  lessons Lesson[] @relation("GeneratedLessons")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/// ğŸ“† GERÃ‡EKLEÅEN DERS (Event)
/// Takvimde gÃ¶rÃ¼nen, yoklamasÄ± alÄ±nan somut ders kaydÄ±.
model Lesson {
  id    String @id @default(uuid())
  title String

  // -- Zaman --
  startTime DateTime // Tam tarih ve saat (12.10.2023 14:00)
  endTime   DateTime

  // -- Kaynak --
  // Bu ders hangi ÅŸablondan Ã¼retildi? (Manuel eklenen derslerde boÅŸ olabilir)
  scheduleItemId String?
  scheduleItem   ScheduleItem? @relation("GeneratedLessons", fields: [scheduleItemId], references: [id], onDelete: SetNull)

  // -- Detaylar --
  type         LessonType   @default(PRIVATE)
  status       LessonStatus @default(SCHEDULED)
  cancelReason String?

  location    LessonLocation @default(ONLINE)
  locationUrl String?
  address     String?

  publicNote  String? // Ã–ÄŸrenci gÃ¶rÃ¼r
  privateNote String? // Sadece hoca gÃ¶rÃ¼r

  // -- Finans --
  price    Decimal? @db.Decimal(10, 2)
  currency String   @default("TRY")
  isPaid   Boolean  @default(false)

  // -- Ä°liÅŸkiler --
  teacherId String
  teacher   TeacherProfile @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  students    StudentProfile[] @relation("LessonToStudentProfile")
  classroomId String?
  classroom   Classroom?       @relation(fields: [classroomId], references: [id])

  // -- Alt Veriler --
  attendances Attendance[]
  homeworks   Homework[]
  materials   Material[]
  payments    Payment[]    @relation("LessonPayment")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ========================================================
// ğŸ“š 4. EÄÄ°TÄ°M MATERYALLERÄ° VE Ã–DEVLER
// ========================================================

/// Derse eklenen dosya veya linkler.
model Material {
  id        String   @id @default(uuid())
  title     String
  
  // File storage fields
  fileId    String?
  file      File?    @relation(fields: [fileId], references: [id])
  linkUrl   String?  // External Link
  
  type      FileType
  lessonId  String
  createdAt DateTime @default(now())
  lesson    Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)
}

/// Verilen Ã–dev (Ana BaÅŸlÄ±k).
model Homework {
  id           String   @id @default(uuid())
  title        String
  content      String?
  assignedDate DateTime @default(now())
  dueDate      DateTime
  lessonId     String
  lesson       Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  trackings HomeworkTracking[] // Hangi Ã¶ÄŸrenci ne durumda?
}

/// Ã–dev Takibi (Ã–ÄŸrenci bazlÄ± durum).
/// Ã–ÄŸretmenin "YaptÄ±/YapmadÄ±" iÅŸaretlediÄŸi yer.
model HomeworkTracking {
  id          String         @id @default(uuid())
  homeworkId  String
  studentId   String
  status      HomeworkStatus @default(PENDING)
  studentNote String?
  teacherNote String?
  
  fileId      String?
  file        File?    @relation(fields: [fileId], references: [id])

  checkedAt   DateTime?

  homework Homework       @relation(fields: [homeworkId], references: [id], onDelete: Cascade)
  student  StudentProfile @relation(fields: [studentId], references: [id])
}

/// Ã–ÄŸrencinin Ã¶dev teslimi (GeliÅŸmiÅŸ kullanÄ±m).
model HomeworkSubmission {
  id          String         @id @default(uuid())
  
  fileId      String?
  file        File?    @relation(fields: [fileId], references: [id])

  note        String?
  submittedAt DateTime       @default(now())
  studentId   String
  student     StudentProfile @relation(fields: [studentId], references: [id])
}

// ========================================================
// ğŸ“Š 5. PERFORMANS VE YOKLAMA
// ========================================================

/// Okul SÄ±nav SonuÃ§larÄ± (YazÄ±lÄ±lar).
model SchoolExam {
  id        String         @id @default(uuid())
  title     String
  score     Float
  date      DateTime
  subject   String
  studentId String
  student   StudentProfile @relation(fields: [studentId], references: [id])
}

/// Deneme SÄ±navÄ± (Ana KayÄ±t).
model TrialExam {
  id         String       @id @default(uuid())
  title      String
  date       DateTime
  category   ExamCategory // TYT, AYT, LGS vb.
  publisher  String? // YayÄ±n evi
  studentId  String
  totalNet   Float?
  totalScore Float?

  student StudentProfile    @relation(fields: [studentId], references: [id])
  results TrialExamResult[] // Ders bazlÄ± sonuÃ§lar
}

/// Deneme SÄ±navÄ± DetaylarÄ± (Ders bazlÄ± netler).
model TrialExamResult {
  id              String   @id @default(uuid())
  trialExamId     String
  lessonName      String // Matematik, TÃ¼rkÃ§e vb.
  correctCount    Int
  incorrectCount  Int
  emptyCount      Int
  net             Float
  mistakeTopics   String[] // YanlÄ±ÅŸ yapÄ±lan konular
  mistakeAnalysis String?

  trialExam TrialExam @relation(fields: [trialExamId], references: [id], onDelete: Cascade)
}

/// Yoklama KaydÄ±.
model Attendance {
  id        String           @id @default(uuid())
  lessonId  String
  studentId String
  status    AttendanceStatus // Geldi, Gelmedi vb.
  note      String?

  lesson  Lesson         @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  student StudentProfile @relation(fields: [studentId], references: [id])
}

// ========================================================
// ğŸ’° 6. FÄ°NANS
// ========================================================

/// Ã–deme KayÄ±tlarÄ±.
model Payment {
  id                 String      @id @default(uuid())
  amount             Decimal     @db.Decimal(10, 2)
  date               DateTime    @default(now())
  type               PaymentType
  note               String?
  isVisibleToStudent Boolean     @default(false)

  studentId String
  teacherId String
  student   StudentProfile @relation(fields: [studentId], references: [id])
  teacher   TeacherProfile @relation(fields: [teacherId], references: [id])

  lessons Lesson[] @relation("LessonPayment") // Hangi dersler iÃ§in Ã¶dendi?
}

// ========================================================
// ğŸ› ï¸ 7. ARAÃ‡LAR VE Ä°LETÄ°ÅÄ°M
// ========================================================

/// YapÄ±lacaklar Listesi.
model Todo {
  id           String    @id @default(uuid())
  content      String
  isCompleted  Boolean   @default(false)
  dueDate      DateTime?
  reminderTime DateTime?
  priority     Priority  @default(MEDIUM)
  userId       String
  createdAt    DateTime  @default(now())
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

/// Genel Takvim EtkinliÄŸi (Ders dÄ±ÅŸÄ± olaylar).
model Event {
  id          String    @id @default(uuid())
  title       String
  description String?
  startDate   DateTime
  endDate     DateTime
  isAllDay    Boolean   @default(false)
  remindAt    DateTime?
  color       String?
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

/// KullanÄ±cÄ±lar arasÄ± mesajlaÅŸma.
model Message {
  id        String    @id @default(uuid())
  content   String?
  
  fileId    String?
  file      File?     @relation(fields: [fileId], references: [id])

  createdAt DateTime  @default(now())
  isRead    Boolean   @default(false)
  readAt    DateTime?

  senderId   String
  receiverId String
  receiver   User   @relation("ReceivedMessages", fields: [receiverId], references: [id])
  sender     User   @relation("SentMessages", fields: [senderId], references: [id])
}

/// Sistem Bildirimleri.
model Notification {
  id        String           @id @default(uuid())
  title     String
  body      String
  route     String? // TÄ±klandÄ±ÄŸÄ±nda gidilecek sayfa
  relatedId String? // Ä°lgili kaydÄ±n ID'si (Ders ID vb.)
  type      NotificationType
  isRead    Boolean          @default(false)
  userId    String
  createdAt DateTime         @default(now())
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ========================================================
// ï¿½ 8. DOSYA YÃ–NETÄ°MÄ° (FILE STORAGE)
// ========================================================

model File {
  id          String   @id @default(cuid())
  key         String   // GCS Key: "files/<ownerId>/<uuid>.<ext>"
  filename    String   // Original filename
  mimeType    String
  sizeBytes   Int
  
  ownerId     String
  owner       User     @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  materials           Material[]
  messages            Message[]
  homeworkTrackings   HomeworkTracking[]
  homeworkSubmissions HomeworkSubmission[]
}

// ========================================================
// ï¿½ğŸ“‹ ENUMLAR (SEÃ‡ENEK LÄ°STELERÄ°)
// ========================================================

enum Role {
  ADMIN
  TEACHER
  STUDENT
}

enum DeviceType {
  IOS
  ANDROID
  WEB
}

enum RelationStatus {
  ACTIVE
  ARCHIVED
  PENDING
  BLOCKED
}

enum LessonType {
  PRIVATE
  GROUP
  INSTITUTION
}

enum LessonStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
  MISSED
}

enum LessonLocation {
  ONLINE
  TEACHER_HOME
  STUDENT_HOME
  INSTITUTION
  OTHER
}

enum PaymentType {
  CASH
  BANK_TRANSFER
  CREDIT_CARD
  OTHER
}

enum HomeworkStatus {
  PENDING
  COMPLETED
  INCOMPLETE
  MISSING
  LATE
  SUBMITTED
}

enum ExamCategory {
  TYT
  AYT
  YDT
  LGS
  KPSS
  GENERAL
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  EXCUSED
  LATE
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum NotificationType {
  LESSON_REMINDER
  HOMEWORK_NEW
  HOMEWORK_LATE
  EXAM_RESULT
  PAYMENT
  MESSAGE
  SYSTEM
}

enum FileType {
  PDF
  VIDEO
  LINK
  IMAGE
  OTHER
}
