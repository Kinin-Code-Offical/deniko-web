// --------------------------------------------------------
// DENIKO - PROFESSIONAL TUTORING MANAGEMENT SYSTEM SCHEMA
// --------------------------------------------------------

generator client {
  provider      = "prisma-client-js"
  // Prisma 6 için de bu ayar Cloud Run'da çalışması için şarttır
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL") // Transaction Pool (PgBouncer) - Uygulama burayı kullanır
  directUrl = env("DIRECT_URL") // Session Mode - Sadece Prisma Migrate burayı kullanır
}

// ========================================================
// 1. KULLANICI & GÜVENLİK (USER & AUTHENTICATION)
// ========================================================

enum Role {
  ADMIN
  TEACHER
  STUDENT
}

model User {
  id String @id @default(uuid())

  // Kimlik Bilgileri
  name          String? // Google/Apple'dan gelen tam isim
  firstName     String? // Manuel kayıt için
  lastName      String? // Manuel kayıt için
  email         String?   @unique
  emailVerified DateTime? // Email doğrulama tarihi
  image         String? // Profil fotoğrafı URL
  password      String? // OAuth kullananlar için boş olabilir (Nullable)

  role     Role    @default(STUDENT)
  isActive Boolean @default(true) // Hesap dondurma kontrolü

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // --- İlişkiler ---

  // Auth.js (NextAuth) Bağlantıları
  accounts Account[]
  sessions Session[]

  // Profil Detayları
  teacherProfile TeacherProfile?
  studentProfile StudentProfile?

  // Cihaz & Bildirim
  devices       Device[] // Mobil cihazlar (FCM Token)
  notifications Notification[] // Uygulama içi bildirimler

  // İletişim & Ajanda
  sentMessages     Message[] @relation("SentMessages")
  receivedMessages Message[] @relation("ReceivedMessages")

  todos          Todo[]
  calendarEvents Event[]
}

// OAuth Hesapları (Google, Apple vb.)
model Account {
  id                String  @id @default(uuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

// Web Oturumları
model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// Email Doğrulama ve Şifre Sıfırlama Tokenları
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ========================================================
// 2. MOBİL CİHAZ YÖNETİMİ (PUSH NOTIFICATION)
// ========================================================

model Device {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  deviceType DeviceType // IOS, ANDROID, WEB
  deviceId   String? // Cihazın Unique ID'si
  model      String? // Örn: "iPhone 14 Pro"
  fcmToken   String?    @db.Text // Firebase Cloud Messaging Token

  lastActive DateTime @default(now())

  @@unique([userId, deviceId]) // Çifte kayıt engelleme
}

enum DeviceType {
  IOS
  ANDROID
  WEB
}

// ========================================================
// 3. ÖĞRETMEN & ÖĞRENCİ PROFİLLERİ (CORE LOGIC)
// ========================================================

model TeacherProfile {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  branch String // Örn: Matematik
  bio    String? // Eğitmen hakkında kısa bilgi

  // İlişkiler
  studentRelations StudentTeacherRelation[] // Tüm aktif/pasif öğrencileri
  createdStudents  StudentProfile[]         @relation("CreatedStudents") // Gölge hesap olarak ekledikleri

  classes       Classroom[]
  lessons       Lesson[]
  payments      Payment[]
  scheduleItems ScheduleItem[]
}

model StudentProfile {
  id String @id @default(uuid())

  // --- A. KİMLİK YAPISI ---
  // userId VARSA -> Gerçek Hesap (Uygulamayı kullanıyor)
  // userId YOKSA -> Gölge Hesap (Sadece hoca yönetiyor)
  userId String? @unique
  user   User?   @relation(fields: [userId], references: [id])

  // Gölge hesaplar için isim (User tablosu olmadığı için)
  tempFirstName String?
  tempLastName  String?

  // --- B. BAĞLANTI & DAVET ---
  // Bu hesabı ilk kim oluşturdu? (Opsiyonel, öğrenci kendi de gelebilir)
  creatorTeacherId String?
  creatorTeacher   TeacherProfile? @relation("CreatedStudents", fields: [creatorTeacherId], references: [id])

  inviteToken String? @unique // Davet Linki: deniko.net/join/CODE
  isClaimed   Boolean @default(false) // Hesap gerçek kullanıcıya bağlandı mı?

  // --- C. AKADEMİK BİLGİLER ---
  studentNo  String?
  gradeLevel String? // "12. Sınıf", "Mezun"

  // Veli İletişim (Acil Durum)
  parentName  String?
  parentPhone String?
  parentEmail String?

  // --- D. İLİŞKİLER ---
  teacherRelations StudentTeacherRelation[] // Bağlı olduğu hocalar

  classroomId String?
  classroom   Classroom? @relation(fields: [classroomId], references: [id])

  // Akademik Veriler
  attendances       Attendance[]
  grades            SchoolExam[]
  trialExams        TrialExam[]
  submissions       HomeworkSubmission[]
  homeworkTrackings HomeworkTracking[]

  // Finans
  payments Payment[]

  // Çoklu Derse Katılım
  lessons Lesson[]

  @@index([studentNo])
  @@index([inviteToken])
}

// HOCA <-> ÖĞRENCİ BAĞLANTISI (Pivot Tablo)
model StudentTeacherRelation {
  id String @id @default(uuid())

  teacherId String
  teacher   TeacherProfile @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  studentId String
  student   StudentProfile @relation(fields: [studentId], references: [id], onDelete: Cascade)

  isCreator Boolean        @default(false) // İlk ekleyen hoca mı?
  status    RelationStatus @default(ACTIVE)

  // Hocaya özel gizli notlar (Öğrenci göremez)
  privateNotes String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([teacherId, studentId])
}

enum RelationStatus {
  ACTIVE
  ARCHIVED
  PENDING
  BLOCKED
}

// ========================================================
// 4. AKADEMİK YAPI (DERSLER & SINIFLAR)
// ========================================================

model Classroom {
  id   String @id @default(uuid())
  name String // "12-A", "LGS Grubu"
  year Int // 2024

  students StudentProfile[]

  teacherId String?
  teacher   TeacherProfile? @relation(fields: [teacherId], references: [id])

  schedule ScheduleItem[]
  lessons  Lesson[]
}

// Haftalık Ders Programı Şablonu (Tekrarlayan)
model ScheduleItem {
  id        String @id @default(uuid())
  dayOfWeek Int // 1=Pazartesi ... 7=Pazar
  startTime String // "09:00"
  endTime   String // "09:40"
  subject   String // "Geometri"

  classroomId String
  classroom   Classroom @relation(fields: [classroomId], references: [id], onDelete: Cascade)

  teacherId String?
  teacher   TeacherProfile? @relation(fields: [teacherId], references: [id])
}

// ========================================================
// 5. DERS KAYDI & FİNANS (LESSON & FINANCE)
// ========================================================

model Lesson {
  id    String @id @default(uuid())
  title String // "İntegral Soru Çözümü"

  startTime DateTime
  endTime   DateTime

  type   LessonType   @default(PRIVATE)
  status LessonStatus @default(SCHEDULED)

  location     LessonLocation @default(ONLINE)
  locationNote String? // "Zoom Linki"

  // --- FİNANSAL ---
  price    Decimal? @db.Decimal(10, 2)
  currency String   @default("TRY")
  isPaid   Boolean  @default(false)

  // İlişkiler
  teacherId String
  teacher   TeacherProfile @relation(fields: [teacherId], references: [id])

  students StudentProfile[]

  classroomId String?
  classroom   Classroom? @relation(fields: [classroomId], references: [id])

  homeworks   Homework[]
  materials   Material[]
  attendances Attendance[]

  // Ödeme Bağlantısı (Paket Dersler İçin)
  payments Payment[] @relation("LessonPayment")

  createdAt DateTime @default(now())
}

enum LessonType {
  PRIVATE
  GROUP
  INSTITUTION
}

enum LessonStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
  MISSED
}

enum LessonLocation {
  ONLINE
  TEACHER_HOME
  STUDENT_HOME
  INSTITUTION
  OTHER
}

// FİNANSAL KAYITLAR (ÖĞRETMEN ÖZEL)
model Payment {
  id     String   @id @default(uuid())
  amount Decimal  @db.Decimal(10, 2)
  date   DateTime @default(now())

  type PaymentType
  note String?

  // Öğrenci görsün mü? (Makbuz mantığı)
  isVisibleToStudent Boolean @default(false)

  studentId String
  student   StudentProfile @relation(fields: [studentId], references: [id])

  teacherId String
  teacher   TeacherProfile @relation(fields: [teacherId], references: [id])

  // Hangi dersleri kapsıyor?
  lessons Lesson[] @relation("LessonPayment")
}

enum PaymentType {
  CASH
  BANK_TRANSFER
  CREDIT_CARD
  OTHER
}

// ========================================================
// 6. EĞİTİM ARAÇLARI (ÖDEV, SINAV, YOKLAMA)
// ========================================================

// ÖDEVLER
model Homework {
  id      String  @id @default(uuid())
  title   String
  content String?

  assignedDate DateTime @default(now())
  dueDate      DateTime

  lessonId String
  lesson   Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  // Öğrenci bazlı takip listesi
  trackings HomeworkTracking[]
}

model HomeworkTracking {
  id String @id @default(uuid())

  homeworkId String
  homework   Homework @relation(fields: [homeworkId], references: [id], onDelete: Cascade)

  studentId String
  student   StudentProfile @relation(fields: [studentId], references: [id])

  status HomeworkStatus @default(PENDING)

  studentNote String?
  teacherNote String?
  fileUrl     String?

  checkedAt DateTime?
}

// ÖDEV TESLİMLERİ (Ekstra Dosya Yükleme Tablosu - Opsiyonel)
model HomeworkSubmission {
  id          String   @id @default(uuid())
  // Basit yapı için HomeworkTracking yeterli olabilir ama 
  // çoklu dosya teslimi gerekirse bu tablo kullanılır.
  fileUrl     String?
  note        String?
  submittedAt DateTime @default(now())

  studentId String
  student   StudentProfile @relation(fields: [studentId], references: [id])

  // HomeworkTracking ile bağlanabilir veya direkt Homework ile
  // Şimdilik StudentProfile içinde tanımlı olduğu için boş bırakıyorum,
  // mantığına göre burayı genişletebiliriz.
}

enum HomeworkStatus {
  PENDING
  COMPLETED
  INCOMPLETE
  MISSING
  LATE
}

// OKUL SINAVLARI (Yazılılar)
model SchoolExam {
  id      String   @id @default(uuid())
  title   String
  score   Float
  date    DateTime
  subject String

  studentId String
  student   StudentProfile @relation(fields: [studentId], references: [id])
}

// DENEME SINAVLARI (TYT/AYT)
model TrialExam {
  id    String   @id @default(uuid())
  title String
  date  DateTime

  category  ExamCategory
  publisher String?

  studentId String
  student   StudentProfile @relation(fields: [studentId], references: [id])

  results TrialExamResult[]

  totalNet   Float?
  totalScore Float?
}

model TrialExamResult {
  id          String    @id @default(uuid())
  trialExamId String
  trialExam   TrialExam @relation(fields: [trialExamId], references: [id], onDelete: Cascade)

  lessonName String // "Matematik"

  correctCount   Int
  incorrectCount Int
  emptyCount     Int
  net            Float

  mistakeTopics   String[] // Yanlış konuları
  mistakeAnalysis String?
}

enum ExamCategory {
  TYT
  AYT
  YDT
  LGS
  KPSS
  GENERAL
}

// YOKLAMA
model Attendance {
  id String @id @default(uuid())

  lessonId String
  lesson   Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  studentId String
  student   StudentProfile @relation(fields: [studentId], references: [id])

  status AttendanceStatus
  note   String?
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  EXCUSED
  LATE
}

// ========================================================
// 7. İLETİŞİM & YARDIMCI ARAÇLAR
// ========================================================

model Todo {
  id          String  @id @default(uuid())
  content     String
  isCompleted Boolean @default(false)

  dueDate      DateTime?
  reminderTime DateTime?
  priority     Priority  @default(MEDIUM)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model Event {
  id          String  @id @default(uuid())
  title       String
  description String?

  startDate DateTime
  endDate   DateTime
  isAllDay  Boolean  @default(false)

  remindAt DateTime?
  color    String?

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Message {
  id      String  @id @default(uuid())
  content String?

  fileUrl  String?
  fileType String?
  fileName String?

  createdAt DateTime @default(now())

  isRead Boolean   @default(false)
  readAt DateTime?

  senderId String
  sender   User   @relation("SentMessages", fields: [senderId], references: [id])

  receiverId String
  receiver   User   @relation("ReceivedMessages", fields: [receiverId], references: [id])
}

model Notification {
  id        String           @id @default(uuid())
  title     String
  body      String
  route     String? // Deep Link
  relatedId String?
  type      NotificationType

  isRead Boolean @default(false)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
}

enum NotificationType {
  LESSON_REMINDER
  HOMEWORK_NEW
  HOMEWORK_LATE
  EXAM_RESULT
  PAYMENT
  MESSAGE
  SYSTEM
}

model Material {
  id    String   @id @default(uuid())
  title String
  url   String // GCS
  type  FileType

  lessonId String
  lesson   Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
}

enum FileType {
  PDF
  VIDEO
  LINK
  IMAGE
  OTHER
}

// --------------------------------------------------------
// END OF DENIKO PRISMA SCHEMA
// --------------------------------------------------------
